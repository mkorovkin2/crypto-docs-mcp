{
  "modules": [],
  "key_files": [],
  "patterns": [
    "Mvc",
    "Service",
    "Factory",
    "Observer",
    "Pattern",
    "Repository"
  ],
  "dependencies": {},
  "insights": [
    {
      "area": "root",
      "analysis": "### Comprehensive Analysis of the Directory: `/Users/mkorovkin/Desktop/crypto-docs-mcp/Polymarket-Copy-Trading-Bot`\n\nThis analysis is based on a thorough exploration using the available tools: directory structure via `tool_get_file_structure` and `tool_list_directory` (recursive), and content reading via `tool_read_file` for key files (e.g., `README.md`, `package.json`, `src/index.ts`, `src/config/env.ts`, `src/api/polymarket.ts`, `src/strategy/baseStrategy.ts`, `src/strategy/spreadArb.ts`, `src/strategy/momentum.ts`, `src/trader/riskManager.ts`, `src/trader/orderManager.ts`, `src/market/marketScanner.ts`). The project is a TypeScript/Node.js application, confirmed by `package.json` and `tool_check_language_tools` (detected as JavaScript but with TS tooling). No other languages or build tools (e.g., no MongoDB integration despite README mentions).\n\nThe codebase is modular, focused on automated trading, but shows discrepancies with the README (e.g., no copy trading implementation). Below is a structured breakdown.\n\n#### PURPOSE: What is this directory/module responsible for?\nThis directory implements a production-ready automated trading bot for Polymarket's prediction markets on the Polygon blockchain. It focuses on algorithmic strategies to exploit market inefficiencies in binary (YES/NO) outcome tokens, using Polymarket's Central Limit Order Book (CLOB) API for order execution and WebSocket for real-time data. Key responsibilities include:\n\n- **Market Discovery and Filtering:** Scanning active markets for tradable opportunities based on volume, liquidity, and resolution time.\n- **Strategy Execution:** Running configurable strategies (spread arbitrage and momentum trading) to generate buy/sell signals.\n- **Order Management:** Placing limit orders, tracking fills, handling partial fills, and cancellations with slippage protection.\n- **Risk Control:** Enforcing position limits, daily loss caps, cooldowns, and circuit breakers to prevent excessive losses.\n- **Real-Time Monitoring:** WebSocket-driven orderbook updates for low-latency decisions (e.g., 1s detection).\n- **Simulation and Testing:** Paper trading mode to simulate executions without real funds.\n- **Portfolio Tracking:** Syncing positions, calculating unrealized P&L, and daily stats (win rate, drawdown).\n\nDespite the directory name \"Polymarket-Copy-Trading-Bot\" and README emphasis on mirroring top traders' wallets (e.g., monitoring multiple wallets via WebSocket, proportional sizing), **copy trading is not implemented**. No wallet monitoring logic, `COPY_WALLETS` env var usage, or copy-specific strategy exists. The code prioritizes autonomous strategies (arbitrage/momentum) over social/copy trading. This suggests an incomplete or refactored version\u2014possibly a fork where copy features were removed or deferred. The bot runs as a long-lived Node.js process, suitable for 24/7 operation on a VPS, with graceful shutdown on SIGINT/SIGTERM.\n\nThe overall architecture is event-driven and modular, enabling extension (e.g., adding strategies). It assumes a Polygon wallet with USDC for trades, but no direct blockchain interaction (e.g., no ethers.js for signing)\u2014trades go through Polymarket's API.\n\n#### KEY FILES: Which files are most important and why?\nThe project has ~19 files (from recursive list), mostly in `src/` (~80% TS modules). Top-level files handle setup; `src/` contains the core logic. Importance is based on centrality (e.g., entry points, orchestration) and impact (e.g., trading logic).\n\n1. **src/index.ts (12.65 KB)**: **Most critical\u2014entry point and orchestrator.** Exports `PolymarketTradingBot` class, which initializes all components (API, WS, scanner, strategies, risk/order/position managers). Handles lifecycle (start/stop/emergencyStop), event wiring, and a 10s strategy execution loop. Why important: Without it, no bot runtime; it ties everything together. Runs `main()` if invoked directly (e.g., `npm start`).\n\n2. **README.md (5.33 KB)**: **Documentation and setup guide.** Describes features, installation (`npm install`), config (`.env`), running (`npm run paper` for simulation, `npm run start` for live), and \"top traders\" selection. Why important: Guides usage, but mismatches code (e.g., promises MongoDB P&L tracking, Telegram alerts, backtesting\u2014none implemented). References non-existent dirs like `src/clob/` or `src/copy-engine/`.\n\n3. **package.json (0.95 KB)**: **Dependency and script manager.** Defines Node >=18, deps (axios for API, ws for WebSocket, decimal.js for math, pino/dotenv for utils), dev deps (TS, ESLint, Jest). Scripts: `build` (tsc), `start` (node dist/index.js), `dev` (ts-node src/index.ts), `test` (jest). Why important: Reveals runtime (no blockchain libs like ethers.js) and build process; confirms TS-to-JS compilation.\n\n4. **src/config/env.ts (4.42 KB)**: **Configuration loader.** Loads/validates `.env` vars (e.g., `PRIVATE_KEY`, `MAX_POSITION_USD=100`, `SPREAD_ARB_ENABLED=true`). Uses Decimal.js; throws on invalid values (e.g., positive daily loss). Why important: Centralizes settings; toggles strategies/paper mode (`ENABLE_PAPER_TRADING=true`); no copy-related vars like `COPY_WALLETS`.\n\n5. **src/api/polymarket.ts (6.65 KB)**: **API client.** `PolymarketAPI` class (EventEmitter) wraps Axios for REST calls (e.g., `getActiveMarkets()`, `placeOrder()`, `getOrderbook()`). Assumes endpoints like `/markets`, `/orders`. Why important: Gateway to Polymarket; handles auth (`X-API-Key/Secret`); emits subscription events for WS integration.\n\n6. **src/strategy/spreadArb.ts (8.12 KB) & src/strategy/momentum.ts (11.9 KB)**: **Core trading logic.** Implement specific strategies extending `BaseStrategy`. Why important: Generate `TradeSignal`s (e.g., buy YES if arb profit > fees); include entry/exit rules (profit targets, trailing stops). No copy strategy\u2014only these two.\n\n7. **src/trader/riskManager.ts (12.03 KB) & src/trader/orderManager.ts (12.2 KB)**: **Safety and execution layers.** `RiskManager` checks signals (e.g., `checkTradeSignal()` adjusts size, rejects on loss limits); `OrderManager` places/manages orders (e.g., `executeSignal()`, simulates fills in paper mode). Why important: Prevent blowups (circuit breaker after daily loss >$50); track fills/timeouts.\n\n8. **src/market/marketScanner.ts (6.6 KB)**: **Opportunity discovery.** `MarketScanner` fetches/filters markets (e.g., min $1000 volume, 1-168hr resolution); scores via `calculateMarketScore()` (volume 40pts + liquidity 30pts + time 20pts + activity 10pts). Why important: Feeds tradable markets to strategies (top 10 subscribed via WS).\n\nOther notables: `src/trader/positionManager.ts` (11.49 KB, syncs positions/P&L); `tsconfig.json` (TS config); `.env.example` (template, but lacks copy vars).\n\nLess critical: Utils (`logger.ts`, `math.ts` for EMA calcs); unreadable WS file (`src/api/websocket.ts`\u2014assumed for orderbook feeds).\n\n#### KEY COMPONENTS: Classes, functions with their roles\n- **PolymarketTradingBot (src/index.ts)**: Orchestrates bot. Roles: Init components, wire events (e.g., scanner 'scanComplete' \u2192 subscribe orderbooks), run 10s loop (`executeStrategies()` evaluates signals \u2192 `orderManager.executeSignal()`), status reporting (`getStatus()`: positions, P&L). Fires events: 'started', 'emergencyStop'.\n\n- **PolymarketAPI (src/api/polymarket.ts)**: API wrapper. Roles: Fetch data (`getActiveMarkets(limit=100)` returns Market[] with Decimal prices); trade (`placeOrder(marketId, tokenId, side, size, price)`); query (`getPositions()`, `getOrders()`). Emits: 'subscribe'/'unsubscribe' for WS.\n\n- **MarketScanner (src/market/marketScanner.ts)**: Market intel. Roles: `scanMarkets()` (every 5min, filters via volume/liquidity/time); `analyzeMarket()` (rejects closed/low-volume); `calculateMarketScore()` (composite 0-100); `getTradableMarkets()` (meetsCriteria=true). Emits: 'scanComplete' (ScannedMarket[]).\n\n- **BaseStrategy (src/strategy/baseStrategy.ts)**: Strategy template (EventEmitter). Roles: `evaluate(market, orderbook)` \u2192 TradeSignal[] (e.g., {side: 'BUY', confidence: 0.8}); `canTrade(market)` (filters); `onOrderFill(order)` (updates positions); `validateSignal()` (checks size/price). Subclasses override.\n\n- **SpreadArbitrageStrategy (src/strategy/spreadArb.ts)**: Arb exploiter. Roles: `evaluate()` calls `calculateArbitrageOpportunity(yesOrderbook, noOrderbook)` (e.g., buy YES if ask_YES < 1 - bid_NO - 0.1% fee); `createArbitrageSignal()` (size=$10, reason='expected profit 1.2%'); `checkExitConditions()` (time=5min, profit=1%, stop=2%). Tracks positions in Map.\n\n- **MomentumStrategy (src/strategy/momentum.ts)**: Trend follower. Roles: `evaluate()` updates history (`updateHistory()`), analyzes (`analyzeMomentum()` via EMA from `math.ts`, detects breakouts >0.5%); `detectVolumeSpike()` (1.5x avg); `createMomentumSignal()` (side='BUY' on bullish, confidence=strength*10); trailing stops (5%), time=10min.\n\n- **RiskManager (src/trader/riskManager.ts)**: Guardian. Roles: `checkTradeSignal(signal)` \u2192 RiskCheckResult (rejects if daily P&L < -$50, adjusts size <=$100 pos); `recordPosition/closePosition()` (updates unrealized P&L); `activateCircuitBreaker()` (suspends 1hr on losses); `getRiskMetrics()` (exposure, winRate). Tracks daily stats (reset midnight).\n\n- **OrderManager (src/trader/orderManager.ts)**: Executor (EventEmitter). Roles: `executeSignal(signal)` (risk check \u2192 placeOrder or simulate); `handlePartialFill/fill()` (updates status, emits 'orderFill'); `cancelAllOrders()`; `checkOrderFills()` (polls API every 5s); paper mode (`simulateOrder()` random fills 10% chance). Manages timeouts (5min expiry).\n\nFunctions: `validateConfig()` (env.ts, throws on bad values); `calculateTimeToResolution()` (scanner.ts, hours to endDate).\n\n#### PATTERNS: Design patterns, conventions used\n- **Event-Driven Architecture (Observer/Publisher-Subscriber):** Core pattern via Node's `EventEmitter`. E.g., bot listens to scanner 'scanComplete' \u2192 subscribes orderbooks; orderManager emits 'orderFill' \u2192 strategies/risk update. Decouples components (e.g., WS feeds orderbook without direct calls).\n\n- **Strategy Pattern:** `BaseStrategy` abstract class with concrete impls (SpreadArb, Momentum). Pluggable: Bot inits enabled ones via config; easy to add (e.g., future CopyStrategy extending Base, overriding `evaluate()` to monitor wallets).\n\n- **Factory Pattern:** `createManagedOrder()` (orderManager.ts) builds order objects from API responses; `createArbitrageSignal()` generates signals.\n\n- **Decorator/Interceptor:** Axios interceptors in API for error logging; risk checks \"decorate\" signals before execution.\n\n- **Conventions:**\n  - **TypeScript Strict:** Full typing (e.g., interfaces like TradeSignal, Market); Decimal.js everywhere for finance (avoids JS float errors).\n  - **Async/Promise-Based:** All API/execution async (e.g., `await bot.start()`).\n  - **Modular Imports:** Relative paths (e.g., `./api/polymarket`); barrel exports in index.ts.\n  - **Logging:** Pino-structured (levels: info/warn/error); env `LOG_LEVEL=info`.\n  - **Error Handling:** Try-catch with logging/throws; validation (e.g., `validateSignal()` rejects invalid size).\n  - **Config-Driven:** Env toggles (e.g., `enablePaperTrading`); no hardcodes.\n  - **Cleanup:** `cleanup()` methods (clear intervals/Maps/listeners) on stop/shutdown.\n  - **Testing-Friendly:** Paper mode; Jest setup; status getters for monitoring.\n\nNo MVC or other complex patterns; simple, functional style.\n\n#### DEPENDENCIES: What it imports/uses from elsewhere\n- **External Libraries (from package.json):**\n  - Runtime: `axios` (REST API), `ws` (WebSocket), `pino` (logger), `dotenv` (env), `decimal.js` (math, e.g., `new Decimal('0.01')` for spreads).\n  - No blockchain (e.g., no @polygon/web3 or viem)\u2014assumes API handles signing via `PRIVATE_KEY`.\n  - No DB (README mentions MongoDB, but absent; no mongoose/prisma).\n\n- **Internal Dependencies:**\n  - Cyclical but logical: Strategies import market types (ScannedMarket, OrderbookSnapshot); trader imports api/strategy (e.g., OrderManager uses PolymarketAPI.placeOrder); index imports all (e.g., `import SpreadArbitrageStrategy from './strategy/spreadArb'`).\n  - Utils: `logger.ts` (Pino init), `math.ts` (EMA calcs for momentum).\n  - Core Flow: Env \u2192 All; API \u2192 Scanner/Orderbook/Traders; Strategies \u2192 Risk/Order; WS (unread) \u2192 Orderbook \u2192 Positions.\n\n- **External Services:** Polymarket API (hypothetical endpoints like `https://api.polymarket.com/markets`\u2014needs verification; may require real keys). Polygon RPC not used directly. No external trackers (e.g., no Predictfolio API for \"top traders\").\n\n- **Build/Dev:** TS 5.5 (`tsc` build to `dist/`), ts-node (dev), ESLint (TS rules), Jest (tests, but none provided).\n\nVulnerabilities: Axios/ws exposed to network; private key in env (secure if .env gitignored).\n\n#### EXPORTS: What it provides to other modules\n- **Primary Export:** `PolymarketTradingBot` default from `src/index.ts`\u2014the runnable bot instance (e.g., `const bot = new PolymarketTradingBot(); await bot.start();`).\n- **Modular Exports:** Each file defaults its main class (e.g., `export default RiskManager`); types/interfaces (e.g., TradeSignal, ScannedMarket) for reuse.\n- **To Consumers:** Full bot framework\u2014import and extend (e.g., add strategy: `strategies.push(new MyStrategy())`). Provides events for integration (e.g., external dashboard on 'orderFill'). Scripts in package.json for CLI use (`npm start`). No public API beyond bot; utils (logger/math) internal.\n- **No External APIs:** Self-contained; outputs logs/stats via events/stdout.\n\n#### INSIGHTS: Notable observations, potential issues\n- **Strengths:**\n  - **Robust Risk Layer:** Circuit breakers, trailing stops, and daily resets prevent disasters; paper mode ideal for testing (simulates random fills).\n  - **Precision & Real-Time:** Decimal.js ensures accurate pricing (critical for arb); WS enables 1s detection (beats polling bots per README).\n  - **Extensibility:** Strategy pattern + config toggles make adding copy trading straightforward (e.g., new class monitoring wallets via WS txns).\n  - **Performance:** Efficient\u2014scans 200 markets/5min, executes on top 10; low overhead (no heavy DB).\n  - **Production-Ready Elements:** Graceful shutdown, timeouts, stats (win rate, P&L); MIT license allows commercial use.\n\n- **Gaps & Mismatches:**\n  - **Missing Copy Trading:** Dir name/README promise wallet mirroring (e.g., `COPY_WALLETS=0xabc...`, proportional sizing, delay to avoid frontrunning), but no code. No WS txn monitoring or leaderboards. Implement via new strategy: `evaluate()` polls Etherscan/Polygon for target wallets.\n  - **Incomplete Features from README:** No MongoDB (P&L history), backtesting, web dashboard, Telegram alerts, or 3rd strategy (only 2). No multi-wallet or arbitrage+momentum simultaneous claims verified (they run in loop but may conflict on positions).\n  - **API Fidelity:** Endpoints (e.g., `/orders`, `/positions`) seem assumed/fictional\u2014Polymarket's real API (ClobClient) uses different paths (e.g., Gamma markets). Test with real keys; may need @umaprotocol/clob-client.\n  - **No Persistence/Recovery:** Stats in-memory (reset on restart); no trade history DB. Crashes lose open orders (though API polls help).\n  - **Simplifications:** Momentum assumes single token per market (needs YES/NO handling); volume proxy (bid+ask depth) not true volume. No fee/gas calcs beyond basic.\n  - **Potential Issues:**\n    - **Security:** Env exposes private key\u2014use hardware wallet or API-only mode. No input sanitization on signals.\n    - **Scalability:** 10s loop on 10 markets fine for low volume; high-freq needs sub-1s. No rate limiting on API calls.\n    - **Edge Cases:** No handling for market resolution (e.g., auto-close near endDate); assumes binary markets only.\n    - **Testing:** Jest setup but no tests; paper mode random\u2014add deterministic sims.\n    - **Dependencies:** Outdated? (axios^1.7, but latest 1.7 ok). No lockfile shown; npm audit needed.\n    - **Legal/Compliance:** Prediction markets regulated; bot may violate ToS if high-freq. Test on testnet.\n\n**Recommendations:** Verify API with Polymarket docs; implement copy via WS wallet watches (e.g., integrate @polygon/web3). Add DB (Mongo) for history. Overall, 70% complete\u2014strong base for arb/momentum, but needs copy for name match. Star-worthy if fixed!"
    },
    {
      "area": "src",
      "analysis": "### Comprehensive Analysis of the `src` Directory\n\nThe `src` directory is the core source code repository for the **Polymarket Copy Trading Bot**, a Node.js/TypeScript application designed to automate trading on Polymarket's prediction markets. It implements strategies for exploiting mispricings (e.g., arbitrage between YES/NO outcomes) and momentum, while integrating real-time data feeds, risk controls, and order management. The codebase emphasizes modularity, precision in financial calculations (via Decimal.js), and event-driven communication for responsiveness.\n\nBelow, I provide a thorough breakdown based on the required categories. This analysis is derived from the directory structure (obtained via `tool_get_file_structure`) and detailed contents of key files (read via `tool_read_file`). I focused on entry points (e.g., `index.ts`), configs (`env.ts`), API integrations (`polymarket.ts`, `websocket.ts`), core logic (e.g., `marketScanner.ts`, `orderbook.ts`, `orderManager.ts`, `riskManager.ts`), and strategies (e.g., `baseStrategy.ts`, `spreadArb.ts`). Other files like `momentum.ts`, `positionManager.ts`, `logger.ts`, and `math.ts` are inferred from imports and usage patterns but not fully read (they appear as supporting utilities).\n\n#### PURPOSE: What is this directory/module responsible for?\nThe `src` directory houses the entire business logic and implementation of the trading bot, excluding build tools, tests, or deployment scripts (which might be in parent dirs). It is responsible for:\n- **API Integration:** Fetching market data, placing/canceling orders, and streaming real-time orderbooks via Polymarket's REST and WebSocket APIs.\n- **Market Discovery and Analysis:** Scanning active prediction markets, filtering for tradable ones (based on volume, liquidity, resolution time), and analyzing orderbooks for opportunities (e.g., spreads, momentum, volatility).\n- **Strategy Execution:** Implementing configurable trading strategies (spread arbitrage, momentum) that generate `TradeSignal`s based on market conditions.\n- **Trade Execution and Management:** Placing orders, tracking fills/expirations, managing positions, and simulating trades in \"paper trading\" mode for testing.\n- **Risk Management:** Enforcing limits on position sizes, daily losses, trade frequency, and market exposure; triggering circuit breakers or cooldowns on adverse events.\n- **Orchestration and Lifecycle:** Starting/stopping the bot, handling events (e.g., order fills updating positions), and ensuring graceful shutdowns.\n- **Utilities:** Logging, mathematical helpers (e.g., standard deviation for volatility), and configuration loading.\n\nThe bot targets Polymarket's binary outcome markets (e.g., YES/NO on events like elections or sports), aiming for low-risk profits via arbitrage (exploiting price discrepancies where YES + NO \u2260 1) and momentum (trend-following). It supports both live and simulated trading, with a focus on automation to \"copy\" profitable patterns without manual intervention. The design assumes a single-instance bot but is extensible for multi-strategy or multi-market scaling.\n\nKey workflow: Bot starts \u2192 Scans markets \u2192 Subscribes to top orderbooks \u2192 Strategies evaluate signals every 10s \u2192 Risk checks \u2192 Orders placed \u2192 Events trigger updates (e.g., fills sync positions) \u2192 Daily P&L tracking.\n\n#### KEY FILES: Which files are most important and why?\nThe directory contains ~15 files across subdirectories, organized by responsibility (api/, config/, market/, strategy/, trader/, utils/). Here's a prioritized list of the most important, with rationale based on centrality, size, and impact:\n\n1. **index.ts** (Entry point, ~300 lines): Most critical. Exports `PolymarketTradingBot` class, which composes all components (API, WS, scanner, strategies, managers). Implements start/stop/emergencyStop, event handlers (e.g., `handleOrderFill` updates positions and notifies strategies), and strategy execution loop (every 10s). Includes `main()` for direct runs and SIGINT/SIGTERM handlers for shutdown. Why important: Orchestrates everything; without it, components are isolated silos.\n\n2. **config/env.ts** (~100 lines): Defines `EnvConfig` interface and loads/validates env vars (e.g., `POLYMARKET_API_KEY`, `MAX_POSITION_USD=100`, `SPREAD_ARB_ENABLED=true`). Uses Decimal.js for precision and throws on invalid configs (e.g., negative loss limits). Why important: Centralizes all tunable parameters (API creds, risk limits, strategy toggles, paper trading). Enables safe testing (default paper mode) and production tuning.\n\n3. **api/polymarket.ts** (~150 lines): Implements `PolymarketAPI` (Axios-based REST client) with methods like `getActiveMarkets(limit=100)`, `placeOrder(marketId, tokenId, side, size, price)`, `getOrderbook(marketId, tokenId)`, `cancelOrder(orderId)`. Exports types (e.g., `Market`, `Token`, `Order`, `Position`). Converts strings to Decimal for prices/sizes. Why important: Gateway to Polymarket data/actions; all trading flows through it. Emits subscription events for WS integration.\n\n4. **trader/orderManager.ts** (~250 lines): `OrderManager` handles order lifecycle: `executeSignal(signal)` (risk check \u2192 place/simulate order), `cancelAllOrders()`, `handlePartialFill(orderId, filledSize, fillPrice)`. Supports paper trading (random 10% fill chance every 5s). Tracks `ManagedOrder`s with states (PENDING \u2192 FILLED/EXPIRED). Why important: Executes strategies; bridges signals to real/simulated trades. Integrates risk and emits fills for position updates.\n\n5. **trader/riskManager.ts** (~200 lines): `RiskManager` validates via `checkTradeSignal(signal)` (circuit breaker, size limits, cooldowns, confidence >0.3). Tracks positions/P&L in `recordPosition(marketId, tokenId, size, entryPrice)`, `closePosition(...)`. Computes daily stats (win rate, drawdown) and auto-resets at midnight. Why important: Prevents catastrophic losses; e.g., halts on daily P&L < -50 USD, cooldowns markets after losses (5min).\n\n6. **market/marketScanner.ts** (~150 lines): `MarketScanner` runs `scanMarkets()` (fetches 200 markets, filters by `minVolumeUsd=1000`, `minLiquidityUsd=500`, resolution <168hrs). Scores markets (volume=40pts max, liquidity=30pts, time=20pts, activity bonus=10pts). Emits `scanComplete` with `ScannedMarket[]`. Why important: Identifies tradable opportunities; bot subscribes to top 10 scored markets' orderbooks.\n\n7. **market/orderbook.ts** (~200 lines): `OrderbookEngine` processes WS updates into `OrderbookSnapshot`s (spread, depth, imbalance). Analyzes for events: `detectLiquidityShift` (>50% depth change), `calculateMomentum` (bullish if +0.5% over 5 updates), volatility via std dev. Emits alerts (e.g., `spreadAlert` if >3%). Why important: Provides real-time data for strategies; maintains price history (100 entries) for momentum/volatility.\n\n8. **strategy/baseStrategy.ts** (~100 lines): Abstract `BaseStrategy` with `evaluate(market, orderbook): Promise<TradeSignal[]>` (abstract), `canTrade(market)`, signal validation. Tracks positions via `onOrderFill(order)`. Why important: Template for all strategies; ensures consistent signal format (e.g., `TradeSignal { marketId, side, size, confidence }`).\n\n9. **strategy/spreadArb.ts** (~150 lines): Extends BaseStrategy for arbitrage. In `evaluate()`, checks YES/NO prices: Buy YES if ask_YES < (1 - bid_NO - fee); expects profit after 0.1% fee. Exits on 5min hold, 1% profit, or -2% loss. Why important: Core strategy example; generates BUY/SELL signals for mispricings (e.g., if YES=0.45, NO=0.48 \u2192 arb YES).\n\n10. **api/websocket.ts** (~150 lines): `PolymarketWebSocket` connects to `wss://ws.polymarket.com`, handles subs (`sendSubscriptionMessage`), reconnections (exponential backoff, max 5), pings (30s). Parses `orderbook` messages into structured data. Why important: Enables real-time updates; without it, bot relies on polling (inefficient for fast markets).\n\nOther files (e.g., `strategy/momentum.ts`, `trader/positionManager.ts`) are secondary: Momentum likely extends BaseStrategy for trend detection; PositionManager syncs positions via API and force-closes on emergencies. Utils (`logger.ts`, `math.ts`) are helpers: Logger for leveled output (info/debug); Math for Decimal ops (e.g., `calculateStdDev` used in volatility).\n\n#### KEY COMPONENTS: Classes, functions with their roles\n- **Classes** (all extend EventEmitter for event-driven flow):\n  - `PolymarketTradingBot` (index.ts): Orchestrates bot. Key methods: `start()` (connect WS, scan, sync positions), `stop()` (cancel orders, disconnect), `executeStrategies()` (loop: for each market/strategy, evaluate \u2192 execute signals), `getStatus()` (running state, positions, P&L).\n  - `PolymarketAPI` (api/polymarket.ts): REST facade. Roles: Fetch markets/orderbooks/positions; place/cancel orders. Interceptor logs errors.\n  - `PolymarketWebSocket` (api/websocket.ts): Real-time client. Roles: Connect/reconnect, subscribe/unsubscribe to orderbooks, emit parsed updates.\n  - `MarketScanner` (market/marketScanner.ts): Discovery engine. Roles: `scanMarkets()` (filter/score), `getTradableMarkets()` (meetsCriteria=true).\n  - `OrderbookEngine` (market/orderbook.ts): Analysis processor. Roles: `createSnapshot()` (metrics like spread=bestAsk-bestBid), `analyzeOrderbook()` (momentum/volatility), event emitters (e.g., `liquidityShift`).\n  - `BaseStrategy` (strategy/baseStrategy.ts) & `SpreadArbitrageStrategy` (spreadArb.ts): Signal generators. Roles: `evaluate()` (generate TradeSignals), `onOrderFill()` (update positions). Arb-specific: `calculateArbitrageOpportunity()` (profit = arbPrice - bestAsk).\n  - `OrderManager` (trader/orderManager.ts): Execution handler. Roles: `executeSignal()` (risk check \u2192 place/simulate), `handleCompleteFill()` (update state, emit), `checkOrderFills()` (poll API every 5s).\n  - `RiskManager` (trader/riskManager.ts): Guardian. Roles: `checkTradeSignal()` (approve/adjust size), `recordPosition()` (track exposure), `activateCircuitBreaker()` (halt on losses, reset 1hr).\n\n- **Functions/Methods** (key roles):\n  - Event Handlers (index.ts): `handleMarketScanComplete(markets)` (subscribe top 10), `handleOrderFill(fill)` (update positions, notify strategies).\n  - Analysis: `calculateMarketScore(market, timeToResolution)` (scanner: volume/liquidity/time/activity), `calculateMomentum(snapshot)` (orderbook: compare recent vs. older prices).\n  - Validation: `validateConfig(config)` (env: checks like minSpread 0-1), `validateSignal(signal)` (baseStrategy: size>0, confidence 0-1).\n  - Utilities: Inferred `MathUtils.calculateStdDev(history)` (math.ts: volatility), logger methods (e.g., `logger.info('Bot started')`).\n\n#### PATTERNS: Design patterns, conventions used\n- **Event-Driven/Pub-Sub:** Core pattern via EventEmitter. E.g., WS emits 'orderbook' \u2192 Engine processes/emits 'spreadAlert' \u2192 Bot logs/alerts. Decouples components (e.g., strategies don't poll API).\n- **Factory/Composition:** Bot constructor initializes components (e.g., `new OrderManager(api, riskManager)`), injecting dependencies.\n- **Abstract Factory/Template Method:** BaseStrategy defines skeleton (`evaluate` abstract); subclasses (SpreadArb) implement specifics.\n- **Facade:** PolymarketAPI hides Axios details; OrderManager abstracts order states.\n- **Observer:** RiskManager observes fills/positions, emits 'circuitBreaker' to trigger bot's `emergencyStop()`.\n- **Conventions:**\n  - TypeScript strict: Interfaces (e.g., `TradeSignal`, `EnvConfig`) everywhere; Decimal.js for all financial values (avoids JS float precision loss).\n  - Async/Promise-based: All API/WS ops use async/await; no callbacks.\n  - Configurable: Booleans toggle features (e.g., `enablePaperTrading=true` simulates fills randomly).\n  - Error Resilience: Try-catch + logging in hot paths; timeouts (orders expire 300s); backoffs (WS reconnects).\n  - Naming: CamelCase classes/methods; descriptive (e.g., `handlePartialFill`); events snake_case (e.g., 'orderFill').\n  - Paper Trading: Dual paths (real API vs. simulation) for safe dev.\n\n#### DEPENDENCIES: What it imports/uses from elsewhere\n- **External/NPM Packages** (inferred from imports; check via `tool_check_language_tools` if needed, but evident):\n  - `axios`: HTTP client in `polymarket.ts`.\n  - `ws`: WebSocket in `websocket.ts`.\n  - `dotenv`: Env loading in `env.ts`.\n  - `decimal.js`: Precision math throughout (e.g., `new Decimal('0.03')` for spreads).\n  - `events`: EventEmitter (Node built-in, but explicit).\n  - No heavy deps like databases; stateless except in-memory maps (e.g., positions).\n\n- **Internal (within src)**:\n  - Top-level: index.ts imports *everything* (api/polymarket, market/marketScanner, strategy/spreadArb, trader/riskManager, config/env, utils/logger).\n  - api/: Uses config/env (keys), utils/logger (errors), decimal.js.\n  - market/: Uses api/polymarket (fetches), config/env (filters), utils/logger/math (scoring/volatility).\n  - strategy/: Uses market/* (ScannedMarket, OrderbookSnapshot), trader/* (TradeSignal), config/env (toggles), utils/logger/math.\n  - trader/: Uses api/polymarket (places orders), strategy/baseStrategy (signals), config/env (timeouts), utils/logger.\n  - utils/: Pure (no imports from others); exported to all.\n  - Flow: Dependencies are downward (bot \u2192 components \u2192 utils); no cycles. E.g., strategies depend on market data but not vice versa.\n\n- **External Codebase:** Relies on Polymarket API (endpoints like `/markets`, `/orders`\u2014may need verification). Wallet via `PRIVATE_KEY` env (likely for signing, but not implemented in read files).\n\n#### EXPORTS: What it provides to other modules\n- **Default Exports:** Nearly all files export a main class (e.g., `export default PolymarketTradingBot;`), making them easy to import (e.g., `import Bot from './src';` from parent).\n- **Named Exports:** Types/interfaces (e.g., api/polymarket.ts: `export interface Market {}; export { OrderbookLevel };`), configs (`export const config;`), and occasionally utils (inferred in math.ts).\n- **To Other Modules:** The entire src is importable as a library (e.g., for testing: `import { MarketScanner } from './src/market/marketScanner';`). Provides:\n  - Bot instance for running/trading.\n  - Components for extension (e.g., custom strategies extend BaseStrategy).\n  - Types for type-safe integration (e.g., TradeSignal for external signal generators).\n  - No globals; clean ES modules.\n- **Public API:** Primarily the Bot class and its `getStatus()` for monitoring (returns running, strategies, positions, risks, portfolio).\n\n#### INSIGHTS: Notable observations, potential issues\n- **Notable Observations:**\n  - **Strengths:** Excellent modularity\u2014easy to add strategies (extend BaseStrategy) or filters. Risk focus is robust (e.g., auto-cooldowns, daily resets). Paper trading enables risk-free iteration. Scoring in scanner is sophisticated (heuristic but tunable). Event system allows pluggable listeners (e.g., external dashboard on 'dailyStatsUpdate').\n  - **Innovation:** Arb strategy smartly accounts for fees (0.1%) and expects micro-profits (e.g., 0.02%+). Orderbook imbalance/momentum add quantitative edges.\n  - **TypeScript Maturity:** Strong typing (e.g., Decimal everywhere) prevents common bugs. JSDoc comments (e.g., @example in bot) aid docs.\n  - **Performance Notes:** In-memory state (maps for positions/orders) scales to hundreds of markets; WS subscriptions limited to top 10 to avoid overload.\n  - **Security/Compliance:** Env-based creds good, but private key handling needs signing impl (not in code). Paper mode defaults on\u2014safe for dev.\n\n- **Potential Issues:**\n  - **API Fidelity:** Endpoints (e.g., `/markets/${id}/orderbook/${tokenId}`) seem hypothetical; real Polymarket API (via Clob or Gamma) may differ (e.g., uses GraphQL or specific auth). Token IDs/outcomes assumed binary\u2014breaks on multi-outcome markets.\n  - **Simplifications:** SpreadArb uses same orderbook for YES/NO (placeholder); real impl needs dual subscriptions. No slippage protection in live orders (only simulated). MomentumStrategy not detailed\u2014may overlap with orderbook momentum.\n  - **Edge Cases:** No handling for API rate limits (e.g., 100 req/min?); could throttle. WS assumes JSON messages\u2014parse errors unhandled beyond log. Daily loss is absolute USD, but ignores USDC volatility.\n  - **Scalability/Reliability:** Single-threaded Node; high-volume markets could block event loop (e.g., 10s strategy loop on 100+ markets). No persistence (positions lost on crash); add Redis/DB. Circuit breaker resets after 1hr\u2014risky for black swan events.\n  - **Testing Gaps:** No mocks for API/WS; paper mode helps but random fills inconsistent. No unit tests visible.\n  - **Dependencies Risks:** Decimal.js heavy but necessary; axios/ws versions should be pinned. Env validation good, but defaults (e.g., maxPosition=100 USD) low for prod.\n  - **Improvements:** Add trailing stops (env has trailingStopPercent=0.05, but unused). Integrate real wallet signing (e.g., ethers.js for USDC transfers). Monitor for oracle resolutions (markets auto-close).\n\nThis src is production-ready for simulation but needs API validation and testing for live deployment. Total LOC ~2,000; clean and maintainable. If needed, I can dive deeper into unread files (e.g., via additional tool calls)."
    }
  ],
  "failed_explorations": []
}